# SNMP

## 一、SNMP的简单概述

### 1.1 什么是SNMP

SNMP是英文”Simple Network Management Protocol“的缩写，中文意思是”**简单网络管理协议**“。

SNMP是一种简单网络管理协议，它属性TCP/IP五层协议的**应用层协议**（负责应用程序之间的沟通。网络编程主要针对的就是应用层），用于网络管理的协议。

SNMP主要用于网络设备的管理。

由于SNMP协议简单可靠，受到了众多厂商的欢迎，成为了目前最为广泛的网管协议。



SNMP协议主要由两大部分构成：**SNMP管理站**和**SNMP代理（agent）**。

SNMP管理站是一个中心节点，负责收集维护各个SNMP元素的信息，并对这些信息进行处理，最后反馈给网络管理员；

SNMP代理是运行在各个被管理的网络节点之上，负责统计该节点的各项信息，并且负责与SNMP管理站交互，接收并执行管理站的命令，上传各种本地的网络信息。



SNMP管理站和SNMP代理之间是松散耦合的，它们之间的通信是通过**UDP协议**完成的。

一般情况下，SNMP管理站通过UDP协议向SNMP代理发送各种命令，当SNMP代理收到命令后，返回SNMP管理站所需要的参数。

但当SNMP代理检查到网络元素异常的时候，也可以主动向SNMP管理站发送消息（**Trap**），通告当前异常状况。



SNMP的基本思想：为不同种类的设备、不同厂家生产的设备、不同型号的设备，定义为一个统一的接口和协议，使得管理员可以是使用同一的外观面对这些需要管理的网络设备进行管理。通过网络，管理员可以管理位于不同物理空间的设备，从而大大提高网络管理的效率，简化网络管理员的工作。

### 1.2 SNMP和UDP

SNMP采用UDP协议在管理端和agent之间传输信息。SNMP采用**UDP 161端口**接收和发送请求，**162端口**接收trap，执行SNMP的设备都必须采用这些端口。SNMP消息全部通过UDP端口161接收，只有Trap消息采用UDP端口162。

## 二、SNMP的实现结构

在具体实现上，SNMP为管理员提供了一个网管平台(NMS)，又称为**管理站**，负责网管命令的发出、数据存储、及数据分析。**被**监管的设备上运行一个SNMP代理(Agent)，代理实现设备与管理站的SNMP通信。

管理站与代理端通过**MIB**进行接口统一，MIB定义了设备中的被管理对象。管理站和代理都实现了相应的MIB对象，使得双方可以识别对方的数据，实现通信。管理站向代理申请MIB中定义的数据，代理识别后，将管理设备提供的相关状态或参数等数据转换为MIB定义的格式，应答给管理站，完成一次管理操作。
## 三、SNMP有关的基本概念

一个完整的SNMP系统主要包括管理信息库（MIB）、管理信息结构（SMI）以及SNMP报文协议。

* 管理信息库MIB：任何一个被管理的资源都表示成一个对象，称为被管理的对象。MIB是被管理对象的集合。它定义了被管理对象的一系列属性：对象的名称、对象的访问权限和对象的数据类型等。每个SNMP设备（Agent）都有自己的MIB。MIB也可以看作是NMS（网管系统）和Agent之间的沟通桥梁。

### 3.1 代理和管理站的模型

SNMP分为两种角色：**SNMP管理站（manager）**和**SNMP代理（agent）**。管理站指的是运行了可以执行网络管理任务软件的服务器，通常被称作为**网络管理工作站（NMS）**，NMS负责才采样网络中agent的信息，并接收agent的trap。代理是实际网络设备中用来实现SNMP功能的部分。代理在UDP的**161端口**接收NMS的读写请求消息，管理站在UDP的**162端口**接收代理的事件通告消息（Trap）。所以，一旦获取设备的访问权限（**community**，默认为public），就可以访问设备信息、改写和配置设备参数。由于采用的UDP协议，**不需要在代理和管理站之间保持连接**。

![image-20220718112416171](C:\Users\Sino\AppData\Roaming\Typora\typora-user-images\image-20220718112416171.png)

### 3.2 SNMP的操作命令

SNMP协议对外提供了**三种用于控制MIB对象的基本操作命令**。分别为：**Get**、**Set**和**Trap**。

1、**Get**：管理站读取代理处对象的值。是SNMP协议中使用率最高的一个命令，因为该命令是从网络设备中获得管理设备的基本方式。

2、**Set**：管理站设置代理处对象的值。是一个特权命令，因为可以通过它来改动设备的配置或控制设备的运转状态。它可以设置设备的名称，关掉一个端口或清除一个地址解析表中的项等。

3、**Trap**：代理主动向管理站通报重要事件。它的功能就是在网络管理系统没有明确要求的前提下，由代理通知网络管理系统有一些特别的事件发生了。如果发生意外，代理会向管理站的UDP162端口发送一个消息，告知管理站指定的变量值发生了变化。Trap消息可以用来通知管理站线路的故障、连接的中断和恢复、认证失败等消息。管理站可相应的作出处理。

### 3.3 SNMP报文

SNMP协议定义了数据报的格式，以及网络管理员和管理代理之间的信息交换，它还能控制代理的MIB数据对象。因此，可用于处理管理代理定义的各种任务。

一条SNMP消息由“**版本号**”、“**SNMP共同体名**”和“**协议数据单元（PDU）**”构成，数据包的长度不是固定的。

![image-20220718114052496](C:\Users\Sino\AppData\Roaming\Typora\typora-user-images\image-20220718114052496.png)

* **版本标识符（version identifier）**：用于说明现在使用的是哪个版本的SNMP协议，确保SNMP代理使用相同的协议，每个SNMP代理都**直接抛弃**与自己协议版本不同的数据报
* **团队名（Community Name）**：团队（Community）是基本的**安全机制**，用于实现SNMP网络管理员访问SNMP管理代理时的身份验证。类似于密码，默认值为public。团队名是管理代理的口令，管理员被允许访问数据对象的前提就是网络管理员知道网络代理的口令。
* **协议数据单元（PDU）**：PDU是SNMP消息中的**数据区**，即SNMP通信时报文**数据的载体**。PDU指明了SNMP的消息类型以及其相关参数。

**PDU的5种协议数据单元：**

SNMP规定了5种协议数据单元PDU（也就是SNMP报文），用来在管理进程和代理之间的交换。

1、get-request操作：从代理进程处提取一个或多个参数值。

2、get-next-request操作：从代理进程处提取紧跟当前参数值的下一个参数值。

3、set-request操作：设置代理进程的一个或多个参数值。

4、get-response操作：返回的一个或多个参数值。

5、trap操作：代理进程主动发出的报文。通知管理进程有某些事情发生。



SNMP报文格式：

![image-20220718130132993](C:\Users\Sino\AppData\Roaming\Typora\typora-user-images\image-20220718130132993.png)

可见一个SNMP报文共有三个部分组成，即公共SNMP首部、get/set首部，trap首部、变量绑定。

1、公共SNMP首部，共三个字段：

* 版本：写入版本字段的是版本号-1，对于SNMP（即SNMPV1）则应写入0
* 共同体（Community）：就是一个字符串，作为管理进程和代理进程之间的明文口令，常用的是6个字符“public”
* PDU类型：根据PDU的类型，填入0~4中的一个数字，其对应关系**PDU的5种协议数据单元：**顺序一致

2、get/set首部：

* 请求标识符（request ID）：是由管理进程设置的一个整数值，代理进程在发送get-response报文时也要返回此请求标识符。管理进程可同时向许多代理发送get报文，这些报文都使用UDP传送，先发送的存在后到达的可能。设置了请求标识符可以⑩管理进程能够识别返回的响应报文对应的是哪一个请求报文

* 差错状态（error status）：由代理进程回答时如填入0~5中的一个数字，详情见下表

  | 差错状态 | 名字       | 说明                                  |
  | -------- | ---------- | ------------------------------------- |
  | 0        | noError    | 一切正常                              |
  | 1        | tooBig     | 代理无法将回答装入到一个SNMP报文之中  |
  | 2        | noSuchName | 操作指明了一个不存在的变量            |
  | 3        | badValue   | 一个set操作指明了一个无效值或无效语法 |
  | 4        | readOnly   | 管理进程试图写入一个只读变量          |
  | 5        | genErr     | 其他差错                              |

* 差错索引（error index）：当出现noSuchName、badValue、readOnly的差错时，由代理进程在回答时设置的一个整数，它指明了差错的变量在变量列表中的偏移

3、trap首部：

* 企业（enterprise）：填入trap报文的网络设备的对象标识符

* 代理地址：即代理进程所在系统的地址

* trap类型：此字段正式的名称是generic-trap，共分为下表中的七种

  | trap类型 | 名字                  | 说明                                           |
  | -------- | --------------------- | ---------------------------------------------- |
  | 0        | coldStart             | 代理进行了初始化                               |
  | 1        | warmStart             | 代理进行了重新初始化                           |
  | 2        | linkDown              | 一个接口从工作状态变为故障状态                 |
  | 3        | linkUp                | 一个接口从故障状态变为工作状态                 |
  | 4        | authenticationFailure | 从SNMP管理进程接收到具有一个无效共同体的报文   |
  | 5        | egpNeighborLoss       | 一个EGP相邻路由器变为故障状态                  |
  | 6        | enterpriseSpecific    | 代理自定义的事件，需要用后面的”特定代码“来指明 |

  当使用上述类型2、3、5时，在报文后面变量部分的第一个变量应标识响应的接口。

* 特定代码：特定代码仅在trap类型为6时有效，否则都置为0，它是厂家自定义的事件代码

* 时间戳（timestamp）：指自代理进程初始化到trap报告的事件发生所经历的时间，单位为ms。例如时间戳为1000表明代理进程初始化后1000ms发生了该事件。

4、变量绑定（variable-bindings）：

指明一个或多个变量的名和对应的值。在get或get-next报文中，变量的值应该忽略。

### 3.4 MIB（管理信息库）

**管理信息(MIB)库可以理解成为agent维护的管理对象数据库，MIB中定义的大部分管理对象的状态和统计信息都可以被NMS访问。MIB是一个按照层次结构组织的树状结构，每个被管对象对应树形结构的一个叶子节点，称为一个object，拥有唯一的数字标识符**

网络资源被抽象为对象进行管理。但SNMP中的对象是表示被管资源某一方面的数据变量。对象被标准化为跨系统的类，对象的集合被组织为管理信息库 （MIB）。MIB作为设在代理者处的管理站访问点的集合，管理站通过读取MIB中对象的值来进行网络监控。管理站可以在代理者处产生动作，也可以通过修改变量值改变代理者处的配置。
### 3.5 管理信息结构（SMI）

SMI定义了SNMP框架所用信息的组织、组成和标识，它还为描述MIB对象和描述协议怎样交换信息奠定了基础。

SMI定义的数据类型：

* 简单类型（simple）

  Interger：整型是-2,147,483,648~2,147,483,647的有符号整数

  octet string：字符串是0~65535个字节的有序序列

  OBJECT INENTIFIER：来自按照ASN.1规则分配的对象标识符集

* 简单结构类型（simple-constructed）

  SEQUENCE：用于列表，这一数据类型与”structure“类似

  SEQUENCE OF TYPE：用于表格，这一数据类型与”array“类似

* 应用类型（application-wide）

  IpAddress：以网络序号表示的IP地址。因为是一个32位的值，所以定义为4个字节

  counter：计数器是一个非负的整数，它递增至最大值，而后回零。在SNMPv1中定义的计数器是32位的，即最大值为4,294,967,295

  Gauge：也是一个非负整数，它可以递增或递减，但达到最大值时保持在最大值，最大值为232-1

  time ticks：是一个时间单位，表示以0.01秒为单位计算的时间

* OID（Object Identifier）

  每个管理对象都有自己的OID（Object Identifier）,管理对象通过树状结构进行组织，OID由树上的一系列整数组成，整数之间使用（.）分割，树的叶子节点才是真正能够呗管理的对象

  

  
  
  